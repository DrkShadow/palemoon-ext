// ==UserScript==
// @name           ViewImageOnly
// @grant			none
// @namespace      http://drkshadow.com
// @description    View only images on various image hosting websites
// @grant			none
// @include        http://*.bayimg.com*
// @include		http://linkshrink.net/*
// @include        http://*.usercash.com*
// @include        http://*.images.imageturtle.com*
// @include        http://*.imagefap.com*
// @include        http://*.hotlinkimage.com*
// @include        https://*.imagevenue.com/*
// @include        http://imagebam.com/*
// @include			http*://mirrorace.com/m/*
// @include        http*://www.imagebam.com/*
// @include		   http://*winimg.com/view/*
// @include			*://imgbaron.com/*/*.html
// @include			https://kvador.com/*.html
// @include			*://picbaron.com/*/*.html
// @include			*://picyield.com/*.php
// @include			*://pictwn.com/*.php
// @include			*://outletpic.com/*.php
// @include			*://meetimgz.com/*.php
// @include		*/browse.php?u=*
// @include		https://kropic.com/*.html
// @include		https://fotokiz.com/*.html
// @include		https://crownimg.com/*
// @include		http*://*kproxy.com/servlet/*
// @include        http://*.imagebeaver.com*
// @include        http://*.photobucket.com*
// @include        http://*.shareapic.net*
// @include        http://imgchili.com/show/*
// @include			https://imgair.net/*
// @include        http://*image2you.ru/*/
// @include        http://*imagebunk.com/image/*
// @include		   http://*postimage.org/image/*
// @include		   http://*.galleries.bz/*
// @include		http://*stooorage.com/show/*
// @include		http*vid.com/i*=gallery*
// @include		   http://ilix.in/*
// @include		   http://*.picbucks.com/*
// needs referrer
// @include		   https://fastpic.org/view/*
// @include		   http://*fastpic.ru/view/*
// @include		   http://*imageporter.com/*.html
// @include		http://imgxxx.org/img-*.html
// @include		   http://freakshare.com/*
// @include		https://silverpic.com/*.html
// @include 	https://ouo.io/*=http*
// @include		http://yankoimages.net/*/*.html
// @include		http://imgrock.net/*
// @include		*://imgadult.com/img-*.html
// @include		*://imgadult.com/user-*.html*
// @include		http*imgwallet.com/img-*.html
// @include		http*imgdrive.net/img-*.html*
// @include 	http://amf.pw/*.html
// @include		http://cheapesthosting.xyz/l/img-*
// @include		http://imgrock.pw/*
// @include		http://*.kproxy.com/servlet/riderect.src/*
// @include		http://imgview.net/*
// @include		http://imgview.pw/*
// @include		https://imx.to/img-*.html
// @include		https://imx.to/i/*
// @include		http*://multifilemirror.com/*.html
// @include		http://picstorage.net/?v=*
// @include		http://images.wf/?v=*
// @include			http://imagenimage.com/*/*.*.html
// @include		*://pixxxels.org/image/*/
// @include		http*/viewtopic.php?*
// @include		http*/showthread.php?*
// @include		   http://*imagehyper.com/img.php?*
// @include		   https://vipr.im/*
// @include		   http://ironimg.net/*
// @include		   http://www.imagespicy.site/*
// @include		   http*://www.vestimage.site/*
// @include	http://*pixsense.net/site/v/*
// @include		http://imgoutlet.com/*
// @include		*://imgoutlet.pw/*
// @include		http://imgoutlet.co/*
// @include		http://imgbb.net/v-*.*
// @include		http*://*kproxy.com/doproxy.jsp
// @include		http://piccash.net/*/*/
// @include		http://imgdragon.com/*/*.*.html
// @include		http*://*.directupload.net/*
// @include		http://imgmaze.com/*
// @include		http://imgmaze.pw/*
// @include		https://pics4you.net/*.html
// @include		http://rapidimg.net/img-*.html
// @include		http://*imgtaxi.com/img-*.html
// @include		https://forum.on*t/*
// @include			http://imgtown.net/*
// @include			http://imgtown.co/*
// @include			http://imgtown.pw/*
// @include		   *://imagetwist.com/*
// @include		   http://*pic4you.ru/*
// @include	http://www.shorte.info/*
// @include	http://*imagedax.net/*/*.html
// @include		   https://*pixhost.org/show/*
// @include		   https://*pixhost.to/show/*
// @include		http://pimpandhost.com/*
// @include		https://pimpandhost.com/*
// @include		   http*://postimg.org/image/*
// @include	http://*.urlcash.net/*
// @include	http://*.bbsex.org/noreg.php?*
// @include		   http://*.freean.us/*
// @include		   http://*.rqq.co/
// @include		   http://*.fapoff.com/
// @include		http://imgbar.net/img*
// @include		http://imgrill.com/img-*
// @include		http://fapat.me/img-*
// @include		http://imgdino.com/viewer.php?*
// @include	*://*imgspice.com/*
// @include		   http://adfoc.us/*
// @include		http://imgdiamond.com/*.*
// @include		   http://picp2.com/*
// @include		   http://*lix.in/*
// @include		http://imgserve.net/img-*
// @include		   http://*theseblogs.com/*
// @include		   http://damimage.com/img-*.html
// @include		   http://imagezilla.net/show/*
// @include		   http://www.sharenxs.com/*
// @include http://imgzen.com/*.html
// @include	http://www.imgflare.com/*
// @include http://www.imagefolks.com/img-*
// @include		   http://imgbox.com/*
// @include		   http://*zff.co/*
// @include		   http://*qcc.co/*
// @include		   http://imgfile.org/img-*
// @include		   http://www.imgfile.net/*
// @include		   http://*qqc.co/*
// @include		   http://*cashurl.in/*
// @include		   http://imghost.club/*
// @include			http://imgcash.org/u/*.*
// @include			http://imgmega.com/*/*.*
// @include		   http://*extabit.com/*
// @include		http://imgdew.com/*
// @include https://dewimg.com/*.php
// @include https://tezzpic.com/*.php
// @include		http://imgdew.pw/*
// @include		   http://adf.ly/*
// @include			http://pic-maniac.com/*
// @include		http://shrpic.260mb.net/img-*.html
// @include		http://imgtiger.org/*/*.*
// @include		http://chronos.to/*
// @include		http://sh.st/*
// @include		http://img-pay.com/img-*.html
// @include			http://*turboimagehost.com/*.html
// @include		http://picturedip.com/*/*.html
// @include	http://www.imgbabes.com/*
// @include	http://imgearn.net/*
// @include        http://*linkbucks.com/*
// @include	http://rdlnk.co/*
// @include		http://anonpics.org/img-*.html
// @include        http://*allanalpass.com/*
// @include	http://xlocker.net/*
// @include	http://imagecorn.com/*
// @include	http://imagepicsa.com/*
// @include	http://imgcandy.net/*
// @include	http://image.adlock.org/*
// @include	http://imgtube.net/*
// @include http://gallerynova.se/site/v/*
// @include		   http://xxlink.net/*code=*
// @include	http://*imgtrex.com/*/*.*
// @include		   http://depositfiles.com/*
// @include		  http://dereferer.website/?*
// @include	http://gallerysense.se/site/*
// @include		http://*/?http://*
// @include		http://*/?https://*
// @include		http://*/click?http*
// @include	http://mussi.byethost32.com/img-*
// @include		http://picexposed.com/*
// @include		   http://imgmaster.net/img-*
// @include		   http://imgs.it/img-*
// @include		   http://imgspot.org/img-*
// @include		   http://imgsee.me/*
// @include			http://imgtwyti.com/img-*
// @include		   http*://img.yt/img-*
// @include		   http://gogoimage.org/img-*
// @include		   http://imgclick.net/*
// @include		   http://www.jai*ts.tv/*
// @include		http://multi.hotshare.biz/*
// Linkbucks:
// @include		*/url/http://*
// @include        http://*amy.gs/*
// @include        http://*deb.gs/*
// @include http://piclove.in/*
// @include		http://*.linkbabes.com/*
// @include		*/click.php?http*
// @include		http://*.tinylinks.co/*
// @include        http://*hornywood.tv/*
// @include	http://imgve.com/*
// @include	http://*sexpalace.gs/*
// ==/UserScript==
//
// jshint esversion: 6
// jshint forin: false
// jshint maxerr: 999
// jshint undef: true
// jshint lastsemic: true
// jshint scripturl: true
// jshint browser: true
// jshint devel: true
// jshint nonstandard: true


if (String.prototype.reverse === undefined)
	String.prototype.reverse=function(){return this.split("").reverse().join("");};

{ // global context
const substitutions = [
		['imgoutlet.co/', 'imgoutlet.pw/']
	];

const unproxy_hosts = [
		'imgbaron', 'kvador', 'picbaron', 'pics4you'
	];

if (!doProxy(location.href))
	goURL(getImg(location.href));

function goURL(url) {
	
	// Don't go if equal because we're already there.
	if (url && String(window.location.href).toLowerCase() != url.toLowerCase()) {
		while (url.indexOf('%') != -1) {
			url = unescape(url);
		}
		const i = url.search(/\/[^\/]+\.(com|net)/);
		if (i > 0) 
			url = 'https://' + url.substr(i+1);
		top.location.href = url;
	}
}



function getUrlParts(url) {
	//var fulldomain = document.domain.toLowerCase();
	const schemeless = url.indexOf('://') + 3;
	const fulldomain = url.substr(schemeless, url.indexOf('/', schemeless + 5) - schemeless);
	const revdomain = fulldomain.reverse();

	let tld = revdomain.substr(0,revdomain.indexOf('.')).reverse();
	if (tld.length < 3 && revdomain.indexOf('.', tld.length+1) != -1) {
		const innerdom = revdomain.substr(tld.length+1,revdomain.indexOf('.',tld.length+1) - tld.length-1).reverse();

		// These are the only ones accepted as part of the TLD below the country code.
		if (innerdom == 'ne' || innerdom == 'co' || innerdom == 'net' || innerdom == 'com')
			tld += '.' + innerdom;
	}

	// Get the portion of the domain after the tld (gets whatever is before the
	// next dot, if any dot)
	let domain = revdomain.substr(tld.length + 1);
	if (domain.indexOf('.') != -1)
		domain = domain.substr(0,domain.indexOf('.'));
	domain = domain.reverse();

	return [domain, tld];
}

function doProxy(url) {

	// Is it a proxy?
	if (url.indexOf('/browse.php?u=') < 0 || document.forms.length < 1)
		return false;

	const uinp = document.forms[0].u;
	if (uinp == null)
		return false;
	const u = uinp.value;

	// get the host from u
	const parts = getUrlParts(u);
	domain = parts[0];

	if (unproxy_hosts.includes(domain))
		top.location.href=u;

	return true;
}


function getImg(url) {
	const urlLow = url.toLowerCase();
	const realUrl = getRealUrl(url, urlLow);
	if (realUrl) {
		return realUrl;
	}

	// Handle forums.
	if (url.indexOf('/viewtopic.php?') > 0 || url.indexOf('/showthread.php?') > 0) {
		forumsubst();
		return;
	}

	parts = getUrlParts(urlLow);
	domain = parts[0];
	tld = parts[1];

	switch (tld) {
	case 'biz':
		switch (domain) {
		case 'hotshare':
			if (document.getElementById('lcode') != null) {
				const loadNext = function() {
						if (document.forms.length < 1) {
							setTimeout(loadNext, 6000);
							return;
						}
						document.forms[0].submit();
					};
				loadNext();
			}
			else if (document.getElementById('btns') != null) {
				// Open a new tab for each hoster link
				const links = document.getElementsByTagName('a');
				let lastlink;
				for (const link of links) {
					if (link.href == null) continue;

					link = link.href;
					if (link.substr(28,1) != '_')
						continue;

					if (lastlink != null)
						window.open(lastlink);
					lastlink = link;
				}
				document.location.href = lastlink;
			}
			return null;
		}
		break;

	case 'co':
		switch (domain) {
		case 'imgoutlet':
			return continueToImagedotdotdot();

		case 'imgtown':
			return null;
			if (!document.forms.length) {
				// from html.. function piccload
				//
			}

//			for (let i in forms) {
//				let form = document.forms[i];
//				if (!form.getAttribute || form.getAttribute('name') != 'next') {
//					continue;
//				}
//				console.log(form.parentNode.innerHTML);
//				// Check the CSS for the classname. If it's hidden, skip..
//				let found = 0;
//				for (let j in rules) {
//					rule = rules[j];
//					if (index('.' + form.className, rule.cssText) >= 0) {
//						if (index('hidden', rules.cssText) >= 0) {
//							found = 1;
//						}
//					}
//				}
//				alert("Got it: " + form.className);
//				if (found)
//					continue;
//				alert("Got it: " + form.innerHTML);
//				
//
//				form.next.type = 'hidden';
//
//				console.log("Got it: " + form.parentNode.innerHTML);
//				//form.submit();
//
//				return null;
//			}
//			return null;
//			let classes = document.getElementsByClassName('picview');
//			if (classes.length == 1)
//				return classes[0].src;
//

			const searchSheet = function() {
				const forms = document.getElementsByTagName('form');
				const sheet = document.styleSheets[1];
				if (!sheet) {
					setTimeout(searchSheet, 1000);
					return;
				}
				const rules = sheet.cssRules;
				alert('CSS rules: ' + rules.length);
				for (const form of document.forms) {
					alert(form);
					if (!form || !form.className) {
						continue;
					}
					//console.log(form.className);
					// Check the CSS for the classname. If it's hidden, skip..
					let found = 1;
					for (const rule of rules) {
					//	alert(rule + ' -- ' + form.className + ' -- ' + rule.cssText);
						if (rule.cssText.indexOf('.' + form.className) >= 0) {
							if (rule.cssText.indexOf('hidden') >= 0) {
								found = 0;
							}
							// We found the class; hidden or not, stop.
							break;
						}
					}
					if (!found)
						continue;
					//alert("Got it: " + form.innerHTML);
					//form.next.type = 'hidden';
					form.next.mousedown = undefined;
					form.next.click();
					form.next.click();
					setTimeout(function() {
					//form.next.type = 'hidden';
					//form.submit();
					}, 200);
					return;
				}

				//window.location.href = continueToImagedotdotdot();
			}; // searchsheet
			setTimeout(searchSheet, 1000);
			return null;

		// Link Bucks
		case 'rqq':
		case 'qcc':
		case 'qqc':
		case 'zff':
		case 'tinylinks':
			return linkBucks(url, urlLow);

		case 'rdlnk':
			return document.getElementById('urlholder').value;

		} // case 'co'
		break;


	case 'club':
		switch (domain) {
		case 'imghost':
			if (!window.imghost) {
				window.imghost = true;
				document.body.onload = function() {
					window.location.href = getImg(url);
				};
			}
			else {
				const imgs = document.getElementsByTagName('img');
				for (const img of imgs) {
					const alt = img.getAttribute('alt');
					if (alt == null || !alt.length)
						continue;
					const pnt = img.parentNode;
					if (pnt.getAttribute('title') != alt)
						continue;
					if (pnt.getAttribute('class') != 'lightbox')
						continue;

					//console.log(pnt.href + ' -- ' + pnt.alt);
					return img.parentNode.href;
				}
			}

			return null;
		}

		return null;

	case 'com':
		switch (domain) {
		case 'badongo':
			// If we have a download wait object, wait 45 secs and get the download link.
			if (document.getElementById('wait_button') == null)
				return null;

			let checkfunc = function() {
				// Check for the fDownButton object
				let btn = document.getElementById('fDownButton');
				if (btn == null) {
					setTimeout(checkfunc, 1000);
					return;
				}

				// get the onclick of the download image... and strip dodownload's url out of it.
				btn = btn.childNodes[1].innerHTML;
				btn = btn.substr(btn.indexOf('doDownload') + 12);
				btn = btn.substr(0, btn.indexOf("'"));
				// from doDownload()
				goURL(btn + '/ifr?zenc=');
			}; // checkfunc

			setTimeout(checkfunc, 60000);
			return null;

		case 'bayimg':
			return document.getElementById('mainImage').src;

		case 'byethost32':
			let images = document.getElementsByTagName('img');

			for (const image of images) {
				if (image.hasAttribute && image.hasAttribute('alt') && image.getAttribute('alt') == 'image') {
					return image.src;
				}
			}

			document.forms[0].imgContinue.type = 'hidden';
			document.forms[0].submit();
			return null;

		case 'cocoimage':
		case 'picfoco':
			if (urlLow.indexOf('/img.php?') == -1)
				return null;

			let urls = document.getElementsByTagName('a');
			if (urls.length == 1)
				return urls[0].href;

			return document.getElementById('img').src;

		case 'crownimg':
			return continueToImagedotdotdot();


		case 'damimage': {
			let imgs = document.getElementsByTagName('img');
			for (const img of imgs) {
				if (img.getAttribute('alt') == 'image')
					return img.src;
			}
			return null;
			}

		case 'dewimg':
			return continueToImagedotdotdot();

		case 'extabit': {
			let captcha = document.getElementById('download_link_captcha');
			captcha.parentNode.style.display = '';
			return null;

			let timer = document.body.innerHTML;
			timer = timer.substr(timer.indexOf('timerBlock:'), 30);
			timer = timer.substr(timer.indexOf("#")+1);
			timer = timer.substr(0, timer.indexOf("'"));

			captcha = document.body.innerHTML.substr(document.body.innerHTML.indexOf('captchaBlock:'), 30);
			captcha = captcha.substr(captcha.indexOf('#')+1);
			captcha = captcha.substr(0, captcha.indexOf("'"));

			let classes = document.getElementsByClassName('b-download-free');
			for (let i in classes) {
				classes[i].style.display = '';
			}

			document.getElementById(captcha).style.display = '';
			setTimeout(function() {document.getElementById(timer).style.display='';}, 3000);
			return null;
			}

		case 'fotokiz': return picbaron();
		case 'forumophilia': {

			// Find the correct image and replace the page with it.
			let images = document.getElementsByTagName('img');
			let i = 0;
			while (images[i] != null && images[i].src.indexOf('download.php?id=') == -1) {
				//alert(images[i].src);
				i++;
			}

			replacePage(images[i].src);

			return null;
			}

		case 'freakshare':
			let dlbutton = document.getElementById('dlbutton');
			dlbutton.disabled = 'false';
			return null;

		case 'hostwhore':
			return document.getElementById('img_obj').src.split('?')[0];

		case 'hotlinkimage.com':
			let links = document.getElementsByTagName('a');
			for (let i in links) {
				if (links[i].innerHTML == 'If the image is not automaticly loaded, click here to view the image.')
					return links[i].href;
			}
			return document.getElementById('img').src;

		case 'imagebam': {
			// Remove all nodes not leading up to the image. Also put in the script for scaling.
			
			if (urlLow.indexOf('.com/gallery/') > 0)
				return null;

			if (document.getElementById('wait')) {
				document.cookie = 'nsfw_inter=1';

				location.reload();
				return null;
			}
			
			let strong = document.getElementsByTagName('strong');
			for (let i in strong) {
				if (!strong.hasOwnProperty(i))
					continue;

				let p = strong[i].parentNode;
				if (p.tagName != 'P')
					continue;
				if (p.innerHTML.indexOf('has been banned') > 0)
					return null;
			}
		
			// Continue to image?
			let as = document.getElementsByTagName('a');
			for (ai in as) {
				let a = as[ai];
				if (!a.getAttribute || a.getAttribute('title') != 'Continue to your image')
					continue;

				window.location.href = a.href;
				return null;
			}
			
			let menu = document.getElementsByClassName('view-navigation');
			if (menu.length > 0)
				menu = menu[0];

			let images = document.getElementsByTagName('img');
			let image = null;
			for (let i = 0; i < images.length; i++) {
				image = images[i];
				let imgclass = image.getAttribute('class');
				if (imgclass == null)
					continue;
				if (imgclass.substr(0, 10) == 'main-image') {
					image.setAttribute('class', 'main-image');
					image.onclick = null;
					image = image.src;
					break;
				}
			}

			window.onclick = null;

			// Well, rebuild the menu and links for navigation.
			let menuGallery, menuNext, menuPrev;
			for (let i in menu.childNodes) {
				let a = menu.childNodes[i];
				//if (!i.hasAttribute('getAttribute'))
				//	continue;

				//console.log(a.tagName);
				if (!a.tagName || a.tagName.toUpperCase() != 'A')
					continue;

				if (a.getAttribute('href').indexOf('/gallery/') > 0) {
					menuGallery = "" + a.getAttribute('href');
					continue;
				}

				console.log(a);
				const ttl = a.getAttribute('title');
				if (!ttl)	// various upload, ads
					continue;
				if (ttl.indexOf('Next:') == 0) {
					menuNext = "" + a.getAttribute('href');
					continue;
				}
				else if (ttl.indexOf('Previous:') == 0) {
					menuPrev = "" + a.getAttribute('href');
					continue;
				}
			}

			const menuname = document.getElementsByClassName('name')[0];
			console.log(menuname);
			// If it has a next or prev, it's part of a gallery.
			if (menuGallery) {

				menu = {
						menuGallery: menuGallery,
						menuPrev: menuPrev,
						menuNext: menuNext,
						name: menuname.textContent
					};
			}
			else {
				menu = {
						name: menuname.textContent
					};
			}
			console.log('Menu name: ' + menu.name + ' -- ' + menuname.textContent);
			replacePage(image, menu);


			return null;
		}

		case 'imagecorn':
			return corn();

		case 'imagecrack':
			return document.getElementById('thepic').src;

		case 'imagebeaver': {
			/* first take care of age confirmation */
			let links = document.getElementsByTagName('a');
			for (let link in links) {
				link = links[link];
				if (link.href.substr(0,36) == 'http://www.imagebeaver.com/confirm18') {
					return link.href;
				}
			}

			/*due to hotlinking limitation, can't remove proxy*/
			// So use refcontrol.
			return document.getElementById('thepic').src;
			}

		case 'imagebunk': {
			let img = document.getElementById('img_obj');
			img.load = function() { goURL(img.src); };
			setTimeout(img.load, 4000);
			return null;
			}

		case 'imagefap': {
			let img = document.getElementsByTagName('noscript')[0].innerHTML;
			let i = img.indexOf('src="') + 5;
			img = img.substr(i, img.indexOf('"', i) - i);
			return img;
			}

		case 'imagefolks':
			return corn();

		case 'imagehyper':
			return document.getElementById('mainimg').src;

		case 'imagenimage': {
			let pics = document.getElementsByClassName('pic');
			return pics[0].src;
			}

		case 'imagepicsa':
			return corn();

		case 'imageporter': {
			let imgs = document.getElementsByTagName('img');
			for (let i = 0; i < imgs.length; i++) {
				if (imgs[i].src.indexOf('.com/i/') != -1)
					return imgs[i].src;
			}
			return null;
			}

		case 'imagereverb':
			return document.getElementById('picture').src;

		case 'imagesocket':
			return document.getElementById('thumb').src;

		case 'imageturtle':
			if (fulldomain == 'images.imageturtle.com') {
				return url.substring(0,urlLow.indexOf('show.htm?'))+url.substr(urlLow.indexOf('path=')+5);
			}
			break;

		case 'imagetwist': {
			let images = document.getElementsByClassName('pic')[0];
			if (images) {
				return replacePage(images.src);
			}

			images = document.getElementsByTagName('img');
			for (const img of images) {
				let cls = img.getAttribute('class');
				if (!cls || cls.indexOf('pic') < 0)
					continue;
				
				//return img.src;
				return replacePage(img.src);
			}

			return null;
		}

		case'imagevenue': {
			let divEnabled;

			if ((divEnabled = document.getElementById('divEnabled')) != null) {
				// Jump through the hoops..
				return divEnabled.childNodes[1].childNodes[0].href;
			}

			// this doesn't work because gm won't script on images >:-(
			if (urlLow.indexOf('/th_') != -1) {
				return url.substr(0,urlLow.indexOf('/loc'))+'/img.php?image='+url.substr(urlLow.indexOf('/th_')+4);
			}

			let as = document.getElementsByTagName('a');
			let menu = {};
			for (let a in as) {
				a = as[a];
				if (!a.tagName)
					continue;

				//console.log(a);
				let href = a.getAttribute('href');
				if (href) {
					if (href.indexOf('gal=') > 0) {
						menu.menuGallery = href;
						// Prev/Next are at the top.
						break;
					}
					else if (href.indexOf('img.php') > 0) {
						let txt = a.childNodes[0].textContent;
						//console.log(txt);
						if (txt.indexOf('Previous') >= 0)
							menu.menuPrev = href;
						else if (txt.indexOf('Next') >= 0)
							menu.menuNext = href;
					}
				}
			}

			if (menu.menuGallery) {
				replacePage(unescape(document.getElementById('thepic').src), menu);
				return null;
			}

			let img = document.getElementsByTagName('img');
			for (let i in img) {
				i = img[i];
				let a = i.parentNode;
				if (i.getAttribute('alt') == null || a.tagName != 'A' || a.getAttribute('data-toggle') != 'full')
					continue;

				return i.src;
			}
			return unescape(document.getElementById('thepic').src);
		}

		case 'img-pay':
			return sharethis();

		case 'imgbabes': {
			let head = document.getElementsByTagName('head')[0];
			let script = document.createElement('script');
			script.setAttribute('type','Text/JavaScript');
			script.innerHTML = 'Decode();';
			head.appendChild(script);
			replacePage(document.getElementById('this_image').src);
			return null;
			}

		case 'imgbaron':
			return picbaron();

		case 'imgbox': {
			let img = document.getElementById('img');

			let menu = {};
			let as = document.getElementsByTagName('a');
			for (let a in as) {
				a = as[a];

				if (!a.tagName)
					continue;

				let href = a.getAttribute('href');
				if (!href)
					continue;

				if (href.indexOf('/g/') >= 0) {
					menu.menuGallery = href;
					break;
				}
			}
			if (menu.menuGallery) {
				// Get the others by class name.
				let link = document.getElementsByClassName('icon-arrow-left')[0];
				link = link.parentNode;
				menu.menuPrev = link.getAttribute('href');

				link = document.getElementsByClassName('icon-arrow-right')[0];
				link = link.parentNode;
				menu.menuNext = link.getAttribute('href');
			}

			if (menu.menuGallery) {
				replacePage(img.src, menu);
				return null;
			}

			// Else, forward to the image after we've loaded.
			replacePage(img.src, menu).onload = function() { document.location.href=img.src; };

			return null;
		}

		case 'imgchili': {
			let img = document.getElementById('show_image');
			return null;
			}

		case 'imgdew':
			return document.getElementsByClassName('pic')[0].src;

		case 'imgdiamond':
			return continueToImagedotdotdot();

		case 'imgdino':
			return document.getElementById('cursor_lupa').src;

		case 'imgdragon':
			return continueToImagedotdotdot();

		case 'imgflare':
			return document.getElementById('this_image').src;

		case 'imgrill':
			return sharethis();

		case 'imgmaze':
			return continueToImagedotdotdot();

		case 'imgmega':
			return sharethis();

		case 'imgmaze':
		case 'imgoutlet':
			return continueToImagedotdotdot();
			if (url.substr(url.length - 5) == '.html') {
				// The .html page forwards to a .php
				let fwd = document.getElementsByTagName('script');
				for (let i in fwd) {

					let script = fwd[i].text;
					let idx = script.indexOf('window.location');

					if (idx > -1) {
						idx += 19;
						return script.substr(idx, script.indexOf('"', idx + 1) - idx);
					}
				}

				return null;
			}

			return continueToImagedotdotdot();

		case 'imgspice': {
			const imgs = document.getElementsByTagName('img');
			for (const i of imgs) {
				if (i.getAttribute('id') != null)
					return i.src;
			}

			removeIframes();
			return null;
			}

		case 'imgtaxi':
			return continueToImagedotdotdot();

		case 'imgtrex': {
			let pics = document.getElementsByClassName('pic');
			return pics[0].src;
			}

		case 'imgtwyti':
			if (document.forms.length > 0) {
				document.forms[0].imgContinue.type = 'hidden';
				document.forms[0].submit();
				return;
			}
			return document.getElementsByClassName('centred_resized')[0].src;

		case 'imgve': {
			let pic = document.getElementsByClassName('pic');
			if (pic != null && pic.length == 1) {
				return pic[0].src;
			}
			if (document.forms.length > 0) {
				document.forms[0].next.type = 'hidden';
				document.forms[0].submit();
			}
			return null;
			}

		case 'imgadult': 
		case 'imgwallet':
			return imgadult();


		case 'imgzen':
			return continueToImagedotdotdot();

		case 'kvador':
			return picbaron();
			
		case 'kproxy': {
			let tags = document.getElementsByTagName('meta');
			for (const tag of tags) {
				if (!(tag.hasOwnProperty('http-equiv') && tag.hasOwnProperty('content')))
					continue;
				

				// Initial redirect.
				let url = tag.getAttribute('content');
				url = url.substr(url.indexOf('url=') + 4);
				return url;
			}
			if (url.indexOf('/doproxy') > 0) {
				// Forward is broken. Firefox issue -- doesn't honor refresh in background.
				
				let head = document.getElementsByTagName('head');
				head = head[0].innerHTML;
				let i = head.indexOf('url=') + 4;
				head = head.substr(i, head.indexOf('"', i + 7) - i);
				setTimeout(function() { window.location.href = head; }, 2000);
				return null;
			}


			// Rewrite links to what they actually are..
			let as = document.getElementsByTagName('a');
			for (const a of as) {
				let link = a.getAttribute('href');
				if (link == null)
					continue;

				let linkstart = link.indexOf('/', link.indexOf('/redirect.srv/') + 15) + 1;
				link = link.substr(linkstart);
				let linkhost = link.substr(0, link.indexOf('/'));
				if (linkstart == 0)
					continue;
				//else
					//console.log(linkhost + ' -- ' + link);

				switch (linkhost) {
					// scctigsvqda - imagetwist - cloudflare
					// sddauuby - imghost.club - cloudflare
					// sanqlyv - images.wf
					// stmtxpuby - imgclick
					// snmtbfuby - imgspice
					// svkmqtoby - imgchili
					// svkmqtoby - imgchili
					case 'svkmqtoby':
						a.setAttribute('href', 'http://imagebam.com/' + link.substr(linkhost.length + 9));
						break;
					case 'snqlyvapt':
						a.setAttribute('href', 'http://damimage.com/' + link.substr(linkhost.length + 4));
						break;
					case 'sjvwumsvqda':
						a.setAttribute('href', 'http://imagezilla.net/' + link.substr(linkhost.length + 4));
						break;
					case 'skrzeent':
						a.setAttribute('href', 'http://fastpic.ru/' + link.substr(linkhost.length + 4));
						break;
					case 'spbc':
						a.setAttribute('href', 'http://ssh.tf/' + link.substr(linkhost.length + 4));
						break;
					case 'svjv':
						a.setAttribute('href', 'http://lan.wf/' + link.substr(linkhost.length + 4));
						break;
					case 'sswswpn':
						a.setAttribute('href', 'http://adlink.wf/' + link.substr(linkhost.length + 4));
						break;
					case 'sxni':
						a.setAttribute('href', 'http://yep.pm/' + link.substr(linkhost.length + 4));
						break;
					case 'smusq':
						a.setAttribute('href', 'http://file.al/' + link.substr(linkhost.length + 4));
						break;
					case 'skhu':
						a.setAttribute('href', 'http://yep.pm/' + link.substr(linkhost.length + 4));
						break;
					case 'stz':
						a.setAttribute('href', 'https://imx.to/' + link.substr(linkhost.length + 4));
						break;
				}
			}

			// kproxy -- pass _this_ URL to the getImg parser for processing.
			let thisurl = document.getElementById('kproxy_float_surfbar_input');

			return getImg(thisurl.value);
			}

		case 'kropic': return picbaron();

		case 'meetimgz':
			return continueToImagedotdotdot();
		
		case 'mirrorace': {
			// Get the list of links and loop through them one per half-second.
			let links = Array.from(document.getElementsByClassName('uk-button'));
			let callback = function openLink() {
					for (const link of links) {
						if (!link)
							continue;

						links[i] = null;
	
						link = link.getAttribute('href');
						if (!link || link.substr(0, document.location.href.length) != document.location.href)
							continue;
						//alert(link);

						// Forwards back to the original URL and starts a loop.
						if (link.indexOf('t=') < 10)
							continue;
						if (document.location.href.length == link.length) {
							alert('Document URL length equals launching length, and starts are equal too:' + "\n\n" + link);
							return;
						}

						// Is it a hoster link?
						if (link.indexOf('&') > 0) {
							window.location.href = link;
							break;
						}
						else if (link.indexOf('?t=') > 0) {
							//alert('opening window: ' + i);
							window.open(link, '_blank');
							links = links.slice(i + 1);
							setTimeout(callback, 500);

							break;
						}
						else {
							alert('Unknown link: ' + link);
						}

						// Call it again in case this was just a bad link.
						// Have to let the next page load else I'll get the same last page each time..
						//setTimeout(callback, 3000);
						//https://mirrorace.com/m/b5q2/7202761?t=02afc5740c83d27780b1229829f744ef36abbee6

						// One per timeout.
						break;
					}
					if (links.length == 0)
						window.close();
				};
			setTimeout(callback, 500);
			break;
		}

		case 'multifilemirror': {
			let links = document.getElementsByTagName('img');
			for (const img of links) {

				let src = img.getAttribute('src');
				if (!src || src.indexOf('/download.gif') < 10)
					continue;

				window.open(img.parentNode.getAttribute('href'), '_blank');
			}
			window.close();
			return null;
			}

		case 'outletpic':
			return continueToImagedotdotdot();

		case 'clb1':
		case 'peekatmygirlfriend':
			return document.title;

		case 'photobucket': {
			let l=document.links;
			let ul=document.getElementById('containerThumbnails');

			if (ul){
				void(ul.className='');
				for (let i = 0; i < l.length; i++) {
					if (l[i].href.indexOf('?action=view&current=') > 0) {
						void(l[i].href=l[i].href.replace('?action=view&current=',''));
					}
				}
			}
			if (urlLow.indexOf('action=view') != -1) {
				let action = urlLow.indexOf('?action');
				let amp = urlLow.indexOf('&new', action);
				if (amp > action)
					amp = amp - (action + 21);
				else
					amp = urlLow.length + (action + 21);

				return url.substr(0,action) + url.substr(action+21, amp);
			}

			// Else, remove the damn border bullshit...
			let thumbs = document.getElementsByClassName('flyout');
			for (let i = thumbs.length; i > 0; i--) {
				thumbs[i-1].remove();
			}

			// fix links
			thumbs = document.getElementsByClassName('ninepoint');
			for (const action of thumbs) {
				let amp = thumbs[i].href.indexOf('&', action);
				if (amp < action) {
					amp = thumbs[i].href.length + (action + 21);
				}
				thumbs[i].href = thumbs[i].href.substr(0,action) + thumbs[i].href.substr(action+21, amp);
			}

			return null;
			}

		case 'pic-maniac':
			return continueToImagedotdotdot();

		case 'picbaron':
			return picbaron();

		case 'picexposed':
			return document.getElementsByClassName('pic')[0].src;

		case 'pictwn':
		case 'picyield':
			return continueToImagedotdotdot();

		case 'picp2': {
			let thumb = document.getElementById('d1');
			thumb = thumb.childNodes[0].src;
			let idx = thumb.lastIndexOf('-thumb.');
			thumb = thumb.substr(0, idx) + thumb.substr(idx+6);
			return thumb;
			}

		case 'picturedip':
			return document.getElementsByTagName('img')[0].src;

		case 'pimpandhost': {
			// Global listener for shit that keeps reloading..
			if (urlLow.indexOf('/image/') < 1 && urlLow.indexOf('/album/') < 1) {
				for (const elem of document.childNodes) {
					elem.remove();
					document.remove(elem);
				}
				return;
			}
			if (urlLow.indexOf('/album/') > 0) {
				//console.log('Got album!');
				// Fix the gallery being hidden
				for (const elem of document.getElementsByClassName('collapsing-content')) {
					elem.setAttribute('class', null);
					elem.style.display = 'block';
				}
				return null;
			}

			if (urlLow.indexOf('/image/') > 0) {
				let imgs = document.getElementsByTagName('img');
				let img;
				for (const i of imgs) {
					const id = i.id;
					if (id.length < 1)
						continue;
					//if (!i.hasOwnProperty('id')) {
					//	dioesn't work..
					//	console.log("No ID");
					//	continue;
					//}
					if (id.substr(0,4) == 'img_') {
						img = i;
						break;
					}
				}

				//let img = document.getElementById('light-gallery');
				if (img) {
					// Set up the header
					let menu = {};

					let btns = document.getElementsByClassName('btn');
					for (const btn of btns) {
						if (btn.tagName != 'A')
							continue;

						const ttl = btn.title;
						if (ttl == 'Album') {
							menu.menuGallery = btn.getAttribute('href');
						}
						else if (ttl == 'Next') {
							menu.menuNext = btn.getAttribute('href');
						}
						else if (ttl == 'Previous') {
							menu.menuPrev = btn.getAttribute('href');
						}
					}

					//console.log("Menu: " + JSON.stringify(menu));

					replacePage(img.src, menu);
					//generateNavLinks(menuGallery, menuPrev, menuNext);
					return null;
				}
				else {
					// If we have "Open ads page", then retry.
					let timer = document.getElementsByClassName('countdown-timer-container__time-left');
					if (timer.length > 0) {
						//console.log("set timer ");
						setTimeout(function() {window.location.reload(); }, 10000);
					}

					// remove spam
					const iframes = document.getElementsByTagName('iframe');
					for (const frm of iframes) {
						frm.remove();
					}
					const divs = document.getElementsByClassName('frame-container');
					for (const div of divs) {
						div.remove();
					}

					// some things loaded late
					setTimeout(function() {getImg(url);}, 500);
				}
			} // /image/ in URL

			for (const elem of document.getElementsByClassName('adlock_yes')) {
				elem.parentNode.remove(elem);
			}
			// remove spam.
			for (const ifr of document.getElementsByTagName('iframe')) {
				ifr.parentNode.remove(ifr);
			}

			return null;
			}

		case 'pornimghost':
			for (let i in document.links) {
				if (document.links[i].href.indexOf('pornimghost.com/fullsize/') != -1)
					return document.links[i].href;
			}
			return null;

		case 'sharenxs':
			return document.getElementById('img1').src;

		case 'silverpic': return picbaron();

		case 'stooorage': {
			let images = document.getElementsByTagName('img');
			for (const image of images) {
				if (!image.hasAttribute('onclick') || !image.hasAttribute('onload'))
					continue;

				return image.src;
			}

			return null;
			}

		case 'tezzpic':
			return continueToImagedotdotdot();

		case 'turboimagehost':
			replacePage(document.getElementById('imageid').src);

			return null;

		case 'uploading': {
			// uploading.com has a linkblock that is always present. 
			// download times are surely under 100s, so just get the file after that.
			let checkfunc = function() {
				if (document.getElementById("waitblock").innerHTML != 'Free Download') {
					// wait another second or so
					setTimeout(checkfunc, 1000);
					return;
				}
				// do_request('files', 'get', {file_id: 3809651, action: 'step_2'});
				//document.writeln('<script type="text/javascript" language="JavaScript 1.2">do_step_2();</script>');
				location.href='javascript:(do_step_2())';
				return null;

				// done? ok, do the submit.
				document.getElementById('downloadform').submit();
			}; // checkfunc

			// First, if we're at the first page, submit to the next.
			if (document.getElementById('waitblock') == null || document.getElementById('waitblock').innerHTML == '') {
				// Second, if downloadform is null, we have a free download
				if (!document.getElementById('downloadform')) {
					setTimeout(checkfunc, 1000);
					return null;
				}
				document.getElementById('downloadform').submit();
			}

			// Free download
			if (document.getElementById('waitblock') && !document.getElementById('downloadform')) {
				setTimeout(checkfunc, 1000);
				return null;
			}

			setTimeout(checkfunc, 61000);
			document.body.scrollTop = 500;

			return null;
			}

		case 'usercash':
			if (!urlLow.match(/http:\/\/.*http:\/\/[^\/]*\.usercash\.com/)) {
				if (window.frames[1])
					return document.getElementsByTagName('frame')[1].src;

				if (document.links[0] != null && document.links[0].innerHTML == '<font size="3"><b>Warning: the requested gallery contains adult content, click here to enter ...</b><font></font></font>')
					return document.links[0].href;
			}
			return null;

		case 'webshots': {
			if (urlLow.indexOf('/photo/') == -1)
				return null;

			let imgs=document.getElementsByTagName('img');
			// Find the largest on the page?
			for (let i=0; imgs[i] != null; i++) {
				if (imgs[i].width>=200 && imgs[i].height>=200) {
					url=imgs[i].src;
					break;
				}
			}
			if (url != null)
				return url;
			return null;
			}

		case 'winimg':
			return document.getElementById('image_container').childNodes[0].childNodes[0].src;

		case 'x3vid':
			// source=gallery
			let mainimg = document.getElementById('img-0');

			// Now find the image from the url..
			let imgi = document.getElementsByClassName('content-container')[0].getAttribute('data-id');
			imgis = document.getElementsByTagName('img');
			for (const imgid of imgis) {
				if (!imgid.getAttribute)
					continue;

				let datai = imgid.getAttribute('data-i');
				if (!datai)
					continue;

				if (datai == imgi) {
					imgi = imgid;
					break;
				}
			}
			if (mainimg.src != imgi.src)
				mainimg.src = imgi.src;

			mainimg.parentNode.removeChild(mainimg.nextElementSibling);
			mainimg.parentNode.removeChild(mainimg.nextElementSibling);

			break;

		/////////
		// Link Bucks
		case 'linkbucks':
		case 'picbucks':
		case 'thatsprime':
		case 'qvvo':
		case 'baberepublic':
		case 'zxxo':
		case 'seriousurls':
		case 'placepictures':
		case 'linkbabes':
		case 'thatsprime':
		case 'youfap':
		case 'fapoff':
		case 'theseblogs':
		case 'allanalpass':
			return linkBucks(url, urlLow);

		} // Switch .com domain
		break;	// com

	case 'gs':
		switch (domain) {
		case 'amy':
		case 'deb':
		case 'sexpalace':
			return linkBucks(url, urlLow);
		} // Switch .gs domain.
		break; // 'gs'
	
	case 'im': {
		//switch (domain) {
		// case 'vipr':
		//}

		const downlnk = document.getElementsByClassName('ddownloader');
		if (downlnk) {
			return downlnk[0].href;

		}
		}

	case 'info':
		switch (domain) {
			case 'shorte':
				return document.getElementsByClassName('redirect')[0].href;
		}
		break; // 'info'

	case 'io':
		switch (domain) {
		case 'ouo':
			// https://ouo.io/qs/w9ymsUyj?s=https://...
			return url.substr(url.indexOf('=', url.indexOf('://', 8) - 8) + 1);
		}
		break; // 'io'

	case 'it':
		switch (domain) {
		case 'imgs':
			return document.getElementsByClassName('centred_resized')[0].src;
			break;
			
		}
		break; // 'it'

	case 'ly':
		switch(domain) {
		case 'adf':
			// URL contains url?
			if (urlLow.indexOf('://', 10) > 0) {
				clearListeners();
				return url.substr(url.lastIndexOf('://'));
			}
			// Locked? retry.
			if (urlLow.indexOf('/locked') != -1) {
				setTimeout(function() { window.location.reload(); }, 2000);
				return null;
			}

			// Wait the time and forward.
			setTimeout(function() { document.location.href = document.getElementById('skip_button').getAttribute('href'); }, 10000);

			return null;
		}
		break; // 'ly'

	case 'me':
	switch (domain) {
		case 'fapat':
			return sharethis();

		case 'imgsee':{
			let pics = document.getElementsByClassName('pic');
			if (pics != null && pics[0] != null)
				return pics[0].src;
			document.forms['F1'].submit();
			}
		}
		break; // 'me'


	case 'net':
		switch (domain) {
		case '260mb':
			// shrpic.260mb.net
			return continueToImagedotdotdot();
			return sharethis();

		case 'directupload': {
			if (urlLow.indexOf('/images/') > 0) {
				// /images/
				replacePage(document.getElementById('content').src);
				return null;
			}
			else if (urlLow.indexOf('/file/') > 0) {
				let urls = document.getElementsByTagName('script');
				for (let i in urls) {
					url = urls[i].innerHTML;

					i = url.indexOf("document.getElementById('ImgFrame').src='") + 41;
					if (i > 41) {
						let j = url.indexOf("'", i);
						return url.substr(i, j - i);
					}
				}

				// empty.
				return document.getElementById('ImgFrame').src;
			}
			}

		case 'imagezilla': {
			let img = document.getElementById('photo');
			replacePage(img.src).onload = function() { window.location.href=img.src; };
			return null;
			}

		case 'imagedax': {
			let next = document.createElement('script');
			next.setAttribute('type', 'text/JavaScript');
			next.testContent = 'viewholder.closeIt()';
			document.body.appendChild(next);

			return document.getElementsByTagName('img')[0].src;
			}

		case 'imgair': {
			const buttons = document.getElementsByTagName('button');
			if (buttons.length > 0) {
				const btn = buttons[0];
				btn.click();
				let clickfunc;
				clickfunc = function() { btn.onmouseover(); btn.click(); setTimeout(clickfunc, 1000); };
				setTimeout(clickfunc, 7500);
			}

			removeIframes();
			return null;
			}
			

		case 'imgbar':
			//9f83a951006c6105ff664dfac2a1a70f -> 
			//view/9e003c325e/4511d4c050.jpg
			
			window.addEventListener('load', function() {
					if (urlLow.indexOf('img_show.php') == -1) {
						window.location.href = 'http://imgbar.net/img_show.php?view_id=' + document.forms[0].sid.value;
					}
					else {
						let pics = document.getElementsByTagName('img');
						for (const src of pics) {
							if (src && src.indexOf('view/') > -1) {
								window.location.href = pics[i].src;
								return;
							}
						}
					}
				});
			return;

		case 'imgbb':
			return continueToImagedotdotdot();

		case 'imgcandy':
			return corn();

		case 'imgchili': {
			let img = document.getElementById('show_image');

			if (document.referrer.indexOf('/album/') < 0) {
			let menu = null;
			let buttons = document.getElementsByTagName('button');
			for (let i = 0 ; i < buttons.length; i++) {
				let btn = buttons[i];
				btn = btn.parentNode;
				let href = btn.getAttribute('href');
				if (href && href.substr(0,7) == '/album/') {
					let next = btn.parentNode;
					let prev = next.childNodes[3].href;
					next = next.childNodes[5].href;

					menu = {
							menuGallery: btn.href,
							menuPrev: prev,
							menuNext: next,
						};
					break;
				}
			}
			if (menu != null) {
				clearListeners();
				replacePage(img.src, menu);
				return null;
			}
			} // Referred from gallery?

			return loadonload(img);


			img.onload = function() {
					window.location.href = img.src;
				};

			if (img.complete) {
				return img.src;
			}
			
			return null;
			}

		case 'imgclick':
			//return continueToImagedotdotdot();
			if (document.getElementById('form-captcha')) {
				//document.forms[0].next.type = 'hidden'
				//document.forms[0].submit();
				//return null;
				// This code is no longer used because they're not doing it...?
				1;
			}
			if (document.getElementById('recaptcha_image') != null) 
				return null;
			if (document.forms.length && document.forms[0].next != null) {
				document.forms[0].next.type = 'hidden';
				document.forms[0].submit();
				return null;
			}

			return document.getElementsByClassName('pic')[0].src;
			
		case 'imgdrive': 
			return imgadult();

		case 'imgearn': {
			let imgs = document.getElementsByTagName('img');
			for (const img of imgs) {
				if (img.getAttribute('class') == 'pic')
					return img.src;
			}
			return null;
			}

		case 'imgfile': {
			let bodytext = document.body.innerHTML.substr(document.body.innerHTML.indexOf('soDaBug', 1000), 200);
			bodytext = bodytext.substr(bodytext.indexOf('= "') + 3);
			bodytext = bodytext.substr(0, bodytext.indexOf('"'));
			return bodytext;
			}

		case 'imgmaster':
			if (document.forms.length > 0) {
				document.forms[0][0].type = 'hidden';
				document.forms[0].submit();
				return null;
			}

			// Image has class centred and alt image
			let images = document.getElementsByTagName('img');
			for (let i in images) {
				if (images[i].src != null && images[i].getAttribute('class') == 'centred' && images[i].getAttribute('alt') == 'image')
					return images[i].src;
			}
			break;

		case 'imgrock':
			return continueToImagedotdotdot();

		case 'imgserve': {
			let images=document.getElementsByTagName('img');
			for (const img of images) {
				if (img.hasAttribute('alt') && img.getAttribute('alt') == 'image')
					return img.src;
			}
			return null;
			}

		case 'imgtown':
			return continueToImagedotdotdot();


		case 'imgtube':
			return corn();

		case 'imgview': {
			let links = document.getElementsByTagName('a');
			for (const link of links) {
				let rel = links.getAttribute('rel');
				if (rel == 'nofollow norefferer noopener') {
					link.remove();
					clearListeners();
					break;
				}
			}
			return continueToImagedotdotdot();
		}

		case 'ironimg':
			return continueToImagedotdotdot();

		case 'linkshrink':
			setTimeout(function() {document.getElementsByClassName('bt')[0].click(); }, 7000);
			return null;

		case 'onlyhot': {
			let msg = document.getElementById('adult-box');
			if (msg)
				msg.remove();

			msg = document.getElementById('adult-mask');
			if (msg)
				msg.remove();

			if (document.forms[1] && url.indexOf('/redirect-') > 1) {
				document.forms[1].submit();
			}
			return null;
			}

		case 'piccash': {
			let images = document.getElementsByTagName('img');
			for (const img of images) {
				if (img.getAttribute('onClick')) {
					break;
				}
			}

			let img = img.getAttribute('onClick');
			if (img) {
				let i = img.indexOf('mshow(') + 7;
				img = img.substr(i, img.length - 5 - i);

				return img;
			}

			return null;
			}

		case 'pics4you': return picbaron();

		case 'picstorage': {
			let images = document.getElementsByTagName('img');
			for (const img of images) {
				if (img.parentNode.tagName == 'A') {
					return img.src;
				}
			}
			return null;
			}

		case 'pixsense':

			return pixsense();
			return null;


		case 'rapidimg':
			return continueToImagedotdotdot();

		case 'shareapic': {
			let img = unescape(document.getElementById('thepic').src);
			return 'http://'+img.substr(img.toLowerCase().indexOf('shareapic.net'));
			}

		case 'xxlink':		// Just happens to be the same.
		case 'urlcash': {
			let i;
			if (document.title.substr(1,7) == 'http://') {
				return document.title.substr(1,document.title.length - 2);
			}
			i = document.body.innerHTML.indexOf('linkDestUrl');
			if (i > 0) {
				i += 15;
				return document.body.innerHTML.substr(i, document.body.innerHTML.indexOf('\'', i + 11) - i);
			}
			return document.title;
			}

		case 'xlocker': {
			let imgs = document.getElementsByTagName('img');
			for (const img of imgs) {
				let alt = img.getAttribute('alt');
				if (img.src.substr(img.src.length - alt.length) == alt) {
					replacePage(img.src);
					break;
				}
			}
			return null;
			}

		case 'zshare': {
			let ad = document.getElementById('banner');
			if (ad != null) {
				ad.style.display = 'none';
				ad.innerHTML = '';
			}
			ad = document.getElementById('rmishim');
			if (ad != null) {
				ad.style.display = 'none';
				ad.innerHTML = '';
			}
			ad = document.getElementById('rmiad');
			if (ad != null) {
				ad.style.display = 'none';
				ad.innerHTML = '';
			}
			ad = document.getElementsByTagName('iframe');
			for (let elem in ad)
				ad[elem].src = '';
			ad = document.getElementsByTagName('img');
			for (let elem in ad) {
				elem = ad[elem];
				if (elem.src.indexOf('/ad') != -1)
					elem.src = '';
			}

			// First, check for video
			let i = urlLow.indexOf('/video/');
			if (i > 0)
				return url.substr(0,i) + '/download/' + url.substr(i+7);

			// Else, check for image
			i = urlLow.indexOf('/image/');
			if (i > 0) {

				let obj = document.getElementById('image');
				if (obj == null)
					return null;

				obj = obj.src;

				document.body.innerHTML = ''; //'<img src="' + obj.src + '" id="the_image1">';
				removeSiblings(document.body);

				let elem = document.createElement('img');
				elem.src = obj;
				elem.id = 'img';
				document.body.appendChild(elem);

				// remove stylesheets
				let styles = document.styleSheets;
				for (let i = styles.length - 1; i >= 0; i--) {
					styles.deleteRule(i);
				}

				setScaler(elem);

				return null;
			}

			// Else, we have a download. Get the download URL.
			document.forms[0].submit();

			// Remove spammy iframes
			i = document.getElementsByTagName('iframe');
			i[0].remove();

			return null;
			} // zshare

		case 'yankoimages':
			return document.getElementsByTagName('img')[0].src;

		//////////
		// Linkbucks
		case 'picturesetc':
		case 'linkgalleries':
			return linkBucks();
		}
		break;	// net

	case 'org':
		switch (domain) {
		case 'adlock':
			return corn();

		case 'anonpics':
			return sharethis();

		case 'bbsex':
			return url.substr(urlLow.indexOf('noreg.php?') + 10);

		case 'fastpic': {
			for (const i of document.getElementsByClassName('image')) {
				//console.log(i);
				return i.src;
			}
			return null;
		}

		case 'gogoimage':
			return sharethis();

		case 'imgcash':
			return sharethis();

		case 'imgfile':
			return sharethis();

		case 'imgspot':
			return sharethis();

		case 'imgtiger':
			return continueToImagedotdotdot();

		case 'imgxxx':
			return sharethis();


		case 'pixxxels':
		case 'postimg':
			return loadonload(document.getElementById('main-image'));
		case 'postimage':
			let links = document.getElementsByTagName('a');
			for (const link of links) {

				if (!link.getAttribute || !(link = link.getAttribute('href')))
					continue;

				if (link.substr(-5) == '?dl=1')
					return link.substr(0, link.length - 5);
			}

			return document.getElementById('main-image').src;

		}
		break;	// org

	case 'in':
		switch (domain) {
		case 'ilix':
			let i;
			let rem = document.getElementsByClassName('backk');
			while (rem.length > 0) {
				rem[0].remove();
				rem = document.getElementsByClassName('backk');
			}

			setTimeout(function() { document.frm.consubmit.value='Continue'; document.frm.consubmit.disabled=false; }, 2000);

			break;

		case 'lix':
			if (window.frames[0] != null)
				return document.getElementsByTagName('iframe')[0].src;
			let imgs = document.getElementByTagName('img');
			if (imgs.length > 1)
				return null;
			document.forms[0].submit();
			return null;

		case 'piclove':
			replacePage(document.getElementsByClassName('pic')[0].src);
			return null;

		case 'cashurl':
			return url.substr(urlLow.indexOf('http://', 11));

		}
		break; // 'in'

	case 'am':
		switch (domain) {
		case 'jj':
			return document.getElementById('gsImageView').childNodes[1].src;
		} // .am
		break;

	case 'pw':
		switch (domain) {
		case 'amf':
			{
				let links = document.getElementsByTagName('a');
				let i = 0;
				while (i < links.length) {
					let link = links[i++];

					let href = link.getAttribute('href').toString();
					if (!href)
						continue;

					let idx = ('' + link).indexOf('/out?');
					if (idx < 7)
						continue;

					link.setAttribute('href', href.substr(idx + 5));
				}

				return null;
			}
		case 'imgtown':
		case 'imgdew':
		case 'imgmaze':
		case 'imgview':
		case 'imgrock': {

			let img = document.getElementsByClassName('picview');
			if (img.length > 0) {
				return img[0].src;
			}
			// Remove spam
			let spam = document.getElementsByTagName('img');
			for (const spami of spam) {
				if (!spami.parentNode)
					continue;

				if (spami.parentNode.tagName == 'DIV') {
					// remove the parent, not spami
					spami.parentNode.remove();
				}
			}
			spam = document.getElementsByTagName('A');
			for (const spami of spam) {
				let spamb = spami.childNodes[0];
				if (!spamb)
					continue;
				if (!spamb.tagName)
					spamb = spami.childNodes[1];
				if (!spamb)
					continue;

				//alert("Removing: " + spamb.tagName + ' -- ' + spami.tagName);
				if (spamb.tagName == 'DIV') {
				alert("Removing: " + spami);
					spami.remove();
				}
			}
			let ret = continueToImagedotdotdot();
			if (!ret) {
				setTimeout(function() {
				// Remove all div with a class -- these are spam.
				let badtags = [ 'div','a'];
				for (let j = 0; j < badtags.length; j++) {
					let divs = document.getElementsByTagName(badtags[j]);
					for (const div of divs) {
						//console.log('Checking: ' + div.innerHTML);
						if (div.hasOwnProperty('class') || div.hasOwnProperty('href')) {
							//console.log('Removed.');
							div.remove();
						}
					}
				}}, 2000);
			}

			return ret;
			} // imgrock
		case 'imgoutlet': {
				return continueToImagedotdotdot();
			}

		} // switch

		break;

	case 'ru':
		switch (domain) {
		case 'fastpic':
			// Needs referrer
			let pic = document.getElementById('image');
			replacePage(pic.src).onload = function() { window.location.href=pic.src; };
			return null;

		case 'image2you':
			let imgs = document.getElementsByTagName('img');
			for (let i = 0; i < imgs.length; i++) {
				if (imgs[i].src.indexOf('/allimages/') != -1) {
					url = imgs[i].src;
					i = url.indexOf('/allimages/');
					url = url.substr(0,i + 11) + url.substr(i + 13);
					return url;
				}
			}
			return null;

			case 'linktraff':
				return document.location.href.substr(document.location.href.indexOf('linktraff.ru/') + 13);

			case 'pic4you':
				// Find the -thumb. in the images.
				let images = document.getElementsByTagName('img');
				for (let i in images) {
					if (!images[i].src)
						continue;
					let idx = images[i].src.indexOf('-thumb.');
					if (idx != -1)
						return images[i].src.substr(0, idx) + images[i].src.substr(idx+6);
				}
				return null;

			case 'pixs':
				return document.getElementById('imgg').src;
		} // .ru
		break;

	case 'site':
		switch (domain) {
		case 'imagespicy':
			return pixsense();
		case 'vestimage':
			//alert( 'http://www.pixsense.net' + url.substr(urlLow.indexOf('/site')));
			return 'http://www.pixsense.net' + url.substr(urlLow.indexOf('/site'));
			return pixsense();
		}
		break;
	
	case 'st':
		switch (domain) {
		case 'sh':
			if (urlLow.indexOf('http://') > 0)
				return url.substr(urlLow.indexOf('http://'));
			clearListeners();
			setTimeout(function() {clearListeners(); document.getElementById('skip_button').click(); }, 7500);
			return;
		}
		break;

	case 'bz':
		switch (domain) {
		case 'galleries':
			return linkBucks(url, urlLow);
		}
		break;

	case 'se':
		switch (domain) {
		case 'gallerynova':
			setTimeout(function() {
					document.location.href = document.getElementById('myUniqueImg').src;
				}, 2000);
			setTimeout(function() {
					document.location.href = document.getElementById('myUniqueImg').src;
				}, 5000);
			return document.getElementById('myUniqueImg').src;

		case 'gallerysense':
			let ref = document.body.innerHTML.indexOf('content="1;URL=') + 15;
			let desturl = document.body.innerHTML.substr(ref, document.body.innerHTML.indexOf('"', ref + 15) - ref);
			if (desturl.length > 0 && desturl.length < 1000)
				return desturl;

			let links = document.getElementsByTagName('a');

			for (const link of links) {
				if (link.hasAttribute('target') && link.getAttribute('target') == '_blank') {
					return link.href;
				}
			}
			return null;

		default:
		}
		break; // 'se'

	case 'us':
		switch (domain) {
		case 'adfoc':
			let script = document.getElementsByTagName('script')[3].innerHTML;
			script = script.substr(script.indexOf('var click_url') + 17);
			return script.substr(0, script.indexOf('"'));

		case 'freean':
			return linkBucks(url, urlLow);
		}
		break; // 'us'

	case 'to':
		switch (domain) {
		case 'chronos':
			if (document.forms.length == 1) {
				document.forms[0].next.type = 'hidden';
				document.forms[0].submit();
				return null;
			}
			else {
				return document.getElementsByClassName('pic')[0].src;
			}
			return null;

		case 'imx':
			return sharethis();
		}
		case 'pixhost': {
			// Gallery links?
			let menulinks = document.getElementsByClassName('show-menu');
			let menu = {};
			if (menulinks.length > 0) {
				// Gallery..
				let menuhtml = menulinks[0].innerHTML;
				let idx = menuhtml.indexOf('show-gallery') + 13;
				if (idx > 13) {
					idx = menuhtml.indexOf('href="', idx) + 6;
					let idx1 = menuhtml.indexOf('"', idx);
					let gal = menuhtml.substr(idx, idx1 - idx);
					menu['menuGallery'] = gal;
				}

				idx = menuhtml.indexOf('left-arrow') + 11;
				if (idx > 11) {
					idx = menuhtml.indexOf('href="', idx) + 6;
					let idx1 = menuhtml.indexOf('"', idx);
					let prev = menuhtml.substr(idx, idx1 - idx);
					menu['menuPrev'] = prev;
				}

				idx = menuhtml.indexOf('right-arrow') + 12;
				if (idx > 12) {
					idx = menuhtml.indexOf('href="', idx) + 6;
					let idx1 = menuhtml.indexOf('"', idx);
					let next = menuhtml.substr(idx, idx1 - idx);
					menu['menuNext'] = next;
				}
			}

			if (!menu['menuPrev'] && !menu['menuNext']) {
				// No gallery or one image; go to the image.
				let img = document.getElementById('image');
				return loadonload(img);
			}
			if (!menu['menuGallery']) {
				menu = null;
			}
			let image = document.getElementById('image').src;
			replacePage(image, menu);
			return null;
		}
		break;

	case 'tv':
		switch (domain) {
		case 'hornywood':
			return linkBucks(url, urlLow);
		}

		// Other.
		let remove = document.getElementsByClassName('44')[0];
		if (remove) {
			remove = remove.remove();
		}
		return null;
		// 'tv'

	case 'website':
		// dereferer.website
		return url.substr(urlLow.indexOf('/?') + 2);

	case 'wf':
	switch(domain) {
		case 'images': {
			let images = document.getElementsByTagName('img');
			for (const img of images) {
				if (img.parentNode.tagName == 'A') {
					return img.src;
				}
			}
			return null;
			}
		}
		break; // 'wf'

	case 'xyz':
	switch(domain) {
		case 'cheapesthosting': {
			let cont = document.getElementsByTagName('input');
			for (const input of cont) {
				if (input.name == 'imgContinue') {
					input.click();
					return null;
				}
			}

			let cent = document.getElementsByClassName('centred');
			for (const c of cent) {
				if (c.getAttribute('alt') == 'image')
					return c.src;
			}
			cent = document.getElementsByClassName('centred_resized');
			for (const c of cent) {
				if (c.getAttribute('alt') == 'image')
					return c.src;
			}
			
		}
		return null;
	}
	break; //'xyz'

	case 'yt':
		switch(domain) {
		case 'img':
			return sharethis();
		}
		break;

	} // switch TLD.
}


function picbaron() {
	let pic = document.getElementsByClassName('pic');
	if (!pic.length) {
		document.forms[0].submit();
		// setTimeout(function() {document.forms[0].submit();}, 1000);
		return null;
	}
	
	pic = pic[0];

	if (pic.src.indexOf('imgbaron.com/') > 0 || pic.src.indexOf('picbaron.com/') > 0) {
		// this site doesn't forward properly

		pic.setAttribute('style', '');
		return replacePage(pic.src);
	}

	let fwdfunc = function() {
			if (pic.complete && pic.naturalWidth > 0) {
				console.log("Pic loaded; moving to the pictures URL: " + pic.src);
				window.location.href = pic.src;
				return null;
			}
			if (!pic.complete)
				return;
			console.log("Pic not loaded. Invalid IP message. Going back to reload this page. " + window.location.href);

			// Reload the image?
			// I can't clear it from cache, so.. re-post the gate page.
			history.go(-1);
		};
	pic.onload = fwdfunc;

	// sometimes it loads before this script sets the handler
	if (pic.complete) {
		if (pic.naturalWidth > 0) {
			console.log("Got the pic: " + pic.src);
			return pic.src;
		}
		else {
			console.log("Pic not loaded. Invalid IP message. Going back to reload this page. " + window.location.href);
			history.go(-1);
		}
	}
	console.log("Pic not loaded; waiting for it to load..");

	// Sometimes it doesn't call the .onload even though the pic isn't loaded yet.
	setTimeout(fwdfunc, 3000);


	return null;
}

function imgadult() {

	clearListeners();

	if (document.getElementById('redirect-wait')) {
		let script = document.createElement('script');
		script.innerHTML = '$.post(location.href, {cti: 1, ref: window.ctiref, rc: 0, rp: 1, bt: 1, bw: "gecko"' +
				'}, function(data) { '+
				'	setTimeout(function() {'+
				'			window.location.href = window.location.href;'+
				'		}, 10);'+
    			'}, "text");';
		script.setAttribute('type', 'text/javascript');
		document.body.appendChild(script);
	}

	let img = document.getElementsByClassName('centred_resized');
	if (img.length) {
		img = img[0];
		let newimg = document.createElement('img');
		newimg.setAttribute('src', img.getAttribute('src'));
		newimg.setAttribute('style', img.getAttribute('style'));
		newimg.setAttribute('alt', img.getAttribute('alt'));
		// to hopefully avoid onclick newimg.setAttribtue('class', img.getAttribute('class'));
		
		let newlink = document.createElement('a');
		newlink.setAttribute('href', img.parentNode.getAttribute('href'));
		newlink.appendChild(newimg);
		img.parentNode.parentNode.insertBefore(newlink, img.parentNode);
	}

	let sheet = document.createElement('style');
	sheet.innerHTML = '#b { display: none !important; } div.centered { display: none !important; } a > em {display: none !important; } div.bottom_abs {display: none !important; } #container > div.* { display: none !important; }';
	document.body.appendChild(sheet);

	let spam = (document.getElementsByClassName('if'))[0];
	if (spam)
		spam.remove();

	spam = document.getElementById('b');
	if (spam)
		spam.remove();

	spam = document.getElementById('menu');
	if (spam)
		spam.remove();

	spam = document.getElementById('redirect-ab');
	if (spam)
		spam.remove();

	// Centered spam
	spam = (document.getElementsByClassName('centered'))[0];
	if (spam)
		spam.remove();

	spam = document.getElementsByClassName('bottom_abs');
	if (spam.length > 0) {
		spam = spam[0];
		spam.remove();
	}
	

	spam = document.getElementsByClassName('sidebar')[0];
	if (spam) {
		for (let i = 0; i < 5; i++) {
			// Skip it if it's "More from this gallery"
			if (i == 1 && spam.childNodes[1] && spam.childNodes[1].childNodes[0] && (spam.childNodes[1].childNodes[0].innerHTML == 'More from this gallery' || spam.childNodes[1].childNodes[0].innerHTML == 'More from this user')) {
				i += 2;
				continue;
			}
			if (spam.childNodes[i] && spam.childNodes[i].tagName == 'DIV') {
				while (i > 0) {
					spam.removeChild(spam.childNodes[i--]);
				}
				spam.removeChild(spam.childNodes[i]);
				// break;
				i -= 2;
			}
		}
	}

	// Remove any image without an Alt
	let spams = document.getElementsByTagName('img');
	for (let i = 0; i < spams.length; i++) {
		spam = spams[i];
		if (!spam.hasOwnProperty('alt'))
			spam.remove();
	}

	// Div elements under "container" that aren't of a known reason for being.
	let count = 0;
	let remdivs = function() {
			// So this is a thing.. remove any images without a <a> as the parent.
			let imgs = document.getElementsByTagName('img');
			for (const img of imgs) {
				if (img && img.parentNode && img.parentNode.tagName != 'a' && !img.getAttribute('alt')) {
					img.parentNode.remove();

				}
			}

			let divs = document.getElementById('container');
			for (let div in divs) {
				if (div.tagName == 'div') {
					alert(div.innerHTML);
					let divid = div.getAttribute('id');
					if (divid) {
						alert(divid);
						continue;
					}
						alert(divid);

					let divclass = div.getAttribute('class');
					if (divclass && divclass != 'left-column' && divclass != 'sidebar')
						continue;

					div.remove();
				}
			}
			clearListeners();
			if (count++ < 10)
				setTimeout(remdivs, 500);
		};
	clearListeners();
	remdivs();

	//return continueToImagedotdotdot();
	clearListeners();
	clearListeners(document.getElementsByTagName('html')[0]);
	clearListeners(document.body.parentNode);
}

function pixsense() {
	let doctext = document.body.innerHTML.indexOf('URL=', document.body.innerHTML.indexOf('<noscript') + 11) + 4;
	doctext = document.body.innerHTML.substr(doctext, document.body.innerHTML.indexOf('"', doctext + 11) - doctext);
	
	//alert(doctext);
	// It seems to happen twice per page..
	if (doctext.indexOf('/') < 0) {
	//let doctext = document.body.innerHTML.indexOf('URL=', document.body.innerHTML.indexOf('<noscript') + 11) + 4;
	//doctext = document.body.innerHTML.substr(doctext- 100, document.body.innerHTML.indexOf('"', doctext + 11) - doctext);
	//alert(doctext);
		return null;
	}
	//alert(doctext);
	return doctext;
	let scr = document.createElement('script');
	scr.setAttribute('type', 'Text/Javascript');
	scr.innerHTML = 'window.onbeforeunload = null; setTimeout(function() {document.getElementById("divIdBtnClick").click(); setTimeout(function() { document.getElementById("divIdBtnClick").click(); setTimeout(function() { document.getElementById("myUniqueImg").src;}, 500);}, 500); }, 5400)';
	let head = document.getElementsByTagName('head');
	head = head[0];

	head.appendChild(scr);
}

function sharethis() {

	let image;
	image = document.getElementById('images');
	image = document.getElementsByClassName('centred_resized');
	if (image.length > 0)
		image = image[0];
	image = document.getElementsByClassName('pic');
	if (image.length > 0)
		image = image[0];
	image = document.getElementsByClassName('centred');
	if (image.length > 0)
		image = image[0];

	if (image && document.referrer.indexOf('.yt/gallery') < 0) {
	let menu = null;
	let prev = null;
	let next = null;
	let gal = null;

	let links = document.getElementsByTagName('a');
	for (let i = 0 ; i < links.length; i++) {
		let link = links[i];

		let tmp = link.getAttribute('href');

		if (!tmp)
			continue;

		if (tmp.substr(0,4) == 'img-') {
			if (gal) {
				next = tmp;
				break;
			}
			else {
				prev = tmp;
			}
		}
		if (tmp.substr(0,8) == 'gallery-') {
			gal = tmp;
		}
	}

	if (gal) {
		menu = {
				menuGallery: gal,
				menuPrev: prev,
				menuNext: next,
			};
	}
	if (menu != null) {
		clearListeners();
		replacePage(image.src, menu);
		return null;
	}
	} // Referred from gallery?
	if (image.length)
		return image[0].src;

	if (document.forms.length > 0) {
		if (document.forms[0].imgContinue) {
			document.forms[0].imgContinue.type = 'hidden';
			document.forms[0].submit();
		}
		else if (document.forms[1].imgContinue) {
			document.forms[1].imgContinue.type = 'hidden';
			document.forms[1].submit();
		}
		return;
	}

	return image.src;
}


// imagecorn.com, imgtube.net, ...?
function corn() {
	let img = document.getElementById('image');
	if (img != null) {
		return img.src;
	}
	if (document.forms.length > 0) {
		if (document.forms[0].imgContinue != null)
			document.forms[0].imgContinue.type = 'hidden';
		document.forms[0].submit();
		return null;
	}
	else {
		let imgs = document.getElementsByTagName('img');
		for (let i in imgs) {
			if (imgs[i].getAttribute('alt') == 'image')
				return imgs[i].src;
		}
	}
	return null;
}



function oldCode() {
	if (urlLow.indexOf('depositfiles.com') != -1) {
		// First page, we have a button that says "FREE downloading"
		// this is in forms[1].gateway_result=1
		if (document.forms[1] != null && document.forms[1].childNodes[3] != null && 
			document.forms[1].childNodes[3].value == '1')
			document.forms[1].submit();

		if (document.getElementById('download_url') == null) return;

		let checkfunc = function() {
			// when the display of  id=download_url is nothing, I can download.
			let downloader = document.getElementById('download_url');
			if (downloader.style.display != '') {
				setTimeout(checkfunc, 1000);
				return;
			}

			// First or second child is a form.
			if (downloader.childNodes[1].nodeName == 'FORM')
				downloader.childNodes[1].submit();
		}; // checkfunc

		// in 60 seconds, it's able to download.
		setTimeout(checkfunc, 60000);
	}
	if (urlLow.indexOf('rapidshare.com') != -1) {

		let refresh = function() {
			window.location.href=window.location.href;
		};

		// Error conditions:
		// 1. must wait 15 minutes...
		let error = document.getElementsByClassName('klappbox')[0];
		if (error && error.innerHTML.indexOf('Or try again in about') != -1) {
		//alert(1);
			let time = error.innerHTML.indexOf('Or try again in about') + 22;
			time = error.innerHTML.substr(time);
			time = time.substr(0, time.indexOf(' '));
			setTimeout(refresh, time * 60000);
			return null;
		}
		if (error && error.childNodes[3] && error.childNodes[3].innerHTML) {
			//2. You're currently downloading a file.
			if (error.childNodes[3].innerHTML.substr(0,15) == 'Your IP address') {
			//alert(2);
				// Refresh in 1 minute and call it good.
				setTimeout(refresh, 60000);
				return null;
			}
			//3. "You're download has expired."
			if (error.childNodes[3].innerHTML.substr(0,33) == 'The download session has expired.') {
			//alert(3);
				// Parentnode, two before 3 (1) should be p class=downloadlink. Get the link from that and retry.
				return error.childNodes[1].innerHTML.substr(0,error.childNodes[1].innerHTML.indexOf(' '));
			}
			//var error = document.getElementsByClassName('klappbox')[0];
			// 4. No available slots
			if (error.childNodes[3].childNodes[0] && error.childNodes[3].childNodes[0].innerHTML) {
				if (error.childNodes[3].childNodes[0].innerHTML.substr(0,24) == 'We regret that currently' ||
					error.childNodes[3].childNodes[0].innerHTML.substr(0,47) == 'Currently a lot of users are downloading files.') {
					// 2-min delay
					setTimeout(refresh, 122000);
					return null;
				}
				// 5. Currently a lot of users are downloading files. Please try again in 2 minutes or become
				let time = error.childNodes[3].childNodes[0].innerHTML.indexOf('Please try again in');
				if (time > 0) {
					time = time + 19;
					time = error.childNodes[3].childNodes[0].innerHTML.substr(time, error.indexOf(' ', time));
					//setTimeout(refresh, int(time) * 1000 * );
					setTimeout(refresh, 60000);
					return null;
				}
			}
		}
		if (error.childNodes[5] && error.childNodes[5].innerHTML && error.childNodes[5].innerHTML.indexOf('no more download slots available') > 0) {
			setTimeout(refresh, 120000);
			return null;
		}




		// Start the download
		if (document.getElementById('ff')) {
			//alert('submitting');
			document.getElementById('ff').submit();
			return null;
		}
		// I need to look for a line:
		// var c=###
		// inside <div id="inhaltbox"><script>
		let script = document.getElementById('inhaltbox').childNodes[1].innerHTML;
		let i = script.indexOf('var c=');
		script = script.substr(i+6, 4);
		script = script.substr(0,script.indexOf(';'));	// max 3 digits..


		// id=zeit is the countdown timer.. if it's not there, die.
		//if (document.getElementById('inhaltbox') == null) {
		//	return;
		//}
		let checkfunc = function() {
			//3. "You're download has expired."
			if (error && error.childNodes[3] && error.childNodes[3].innerHTML.substr(0,33) == 'The download session has expired.') {
				//alert(4);
				// Parentnode, two before 3 (1) should be p class=downloadlink. Get the link from that and retry.
				refresh();
				return null;
				//return fourchild.parent.childNodes[1].innerHTML.substr(0,fourchild.parent.childNodes[1].innerHTML.inderOf(' '));
			}

			// When it's done, it will create a form named "dlf" with  an item,
			// <div class="klappo" style="display:none;" id="p1">Download via:<br />
			let test = document.getElementById('p1');
			if (test == null) {
				//alert(5);
				// We were off by a couple seconds. Set this to execute in another 5.
				setTimeout(checkfunc, 1000);
				return;
			}

			//alert(document.forms[0].name);
			document.forms[0].submit();
		}; // checkfunc

		//alert((script + 1) * 1000);
		setTimeout(checkfunc, (script*1 + 1) * 1000);
		return null;
	}
	if (urlLow.indexOf('letitbit.net') != -1) {
		// If we're at the wait page, remove the second frame.
		if (window.frames.length > 0)
			return window.frames[0].src;

		// If we're on teh download frame, /tmpl/tmpl_frame_top.php, then
		// forward to the download page after the specified time.

		let checkfunc = function() {
			let link = document.getElementById('links');
			if (link.style.display != 'block') {
				setTimeout(checkfunc, 1000);
				return;
			}
			link = document.getElementsByTagName('a')[0].href;
			goURL(link);
		}; // checkfunc

		let block = document.getElementById('dvifree');
		if (block != null)
			block.style.display = '';
		else
			setTimeout(checkfunc, 60000);
		return null;
	}


	// Defunkt domain. Did they move? Is their source used elsewhere?..
	if (urlLow.indexOf('myusenet.dyns.net') != -1) {
		//function v(v1,v2,v3,v4,v5,v6){
		//	open("view.php?pic="+escape(v1)+"&resize="+v2+"&jpgq="+v3+"&day="+v4+"&group="+v5+"&name="+escape(v6),"BINARY","fullscreen=0,toolbar=0,locationbar=0,directories=0,status=1,menubar=0,scrollbars=1,resizable=1");
		//};

		//OnClick="v('22063-013.jpg',4,100,20080102,'alt.binaries.models','22063');return false;">
		//
		// Alternative: they just wrap the real image...
		// http://myusenet.dyns.net/members/view.php?pic=22063-011.jpg&resize=4&jpgq=100&day=20080102&group=alt.binaries.models&name=22063
		// http://myusenet.dyns.net/members/alt.binaries.models/200801/02/22063-011.jpg
		//

//		let params = ['view.php?pic=', '&resize=', '&jpgq=',  '&day=', '&group=', '&name='];

		let imgs = document.getElementsByClassName('i1');
		for (let i=0; i < imgs.length; i++) {
			let node = imgs[i].parentNode;
			//alert(node.getAttribute('onclick'));
			let func = node.getAttribute('onclick').substr(2);
			func = func.substr(0,func.indexOf(")"));

			let url = '';

			func = func.split(",");
			for (let j = 0; j < func.length; j++) {
				if (func[j].substr(0,1) == "'") {
					func[j] = func[j].substr(1);
					func[j] = func[j].substr(0,func[j].length-1);
				}
				// Name would be escaped, but it already is..
				if (j == 5)
					func[j] = escape(func[j]);
			}
			//	url += params[j] + arg;
			//}

			url=func[4] + '/' + func[3].substr(0,6) + '/' + func[3].substr(6) + '/' + func[0];

			//if (fewtimes < 10) {
			//alert(url);
			//fewtimes++;
			//}

			//func[0] = func[0].substr(1);
			//func[func.length-1] = func[func.length-1].substr(0,func[func.length-1].length - 1);


			//var url = 'view.php?pic=' + func[0] + '&resize=' + func[1] + '&jpgq=' + func[2] + '&day=' +
			 //  		func[3] + '&group=' + func[4] + '&name=' + func[5];

			node.href = url;
			node.setAttribute('onclick', '');
		}

		return null;
	}
}

function linkBucks(url, urlLow) {
	// if there is a /url, get the url after that.
	let idx;

	//unsafewindow.on
	clearListeners();

	idx = urlLow.indexOf('/url/');
	if (idx > 0) {
		return url.substr(idx+5);
	}

	if (urlLow.indexOf('/verify/') > 0) {
		setTimeout(function() { window.location.reload(); }, 3000);
	}

	// If it has frames, go to the 2nd frame
	if (window.frames.length == 2)
		return window.frames[1].src;

	// var scripts = document.getElementsByTagName('script');
	// for (let i in scripts) alert(i + ": " + scripts[i].src);
	// New javascript method:
	if (document.getElementsByTagName('script')[2].src == 'http://static.linkbucks.com/scripts/intermissionLink.js') {
		// It uses javascript. The function is a _key_ for the encrypted data.
		// Change the function, even to figure out what it does, and you break
		// the decryption. 
		
		setTimeout(function() {
					let time = parseInt(document.getElementById('timer').innerHTML);
					if (isNaN(time))
						time = 6;
					setTimeout(function() {
							document.getElementById('skiplink').click();
						}, (time + 2) * 1000);
			}, 1000);

		return null;
	}

	let lbl = document.getElementById('lb_wrap');
	if (lbl)
		return lbl.childNodes[3].href;

	idx = document.getElementById('frame2');
	if (idx)
		return idx.src;

	// Get the script blocks to find TargetUrl
	let scripts = document.getElementsByTagName('script');
	for (idx = 0; idx < scripts.length; idx++) {
		let script = scripts[idx];
		if (script.innerHTML.length < 20)
			continue;
		let i = script.innerHTML.indexOf('TargetUrl');
		if (i == -1)
			continue;

		script = script.innerHTML;
		i = script.indexOf("'", i) + 1;
		return script.substr(i, script.indexOf("'", i) - i);
	}

	return null;
}

function generateNavLinks(menu) {
	const div = document.createElement('div');

	if (menu.name) {
		console.log('Doing name: ' + menu.name);
		const a = document.createElement('a');
		//a.setAttribute('href', menu.gallery);
		a.innerHTML = menu.name;
		a.style.fontWeight = '600';
		a.style.fontSize = 'xx-small';
		a.style.padding = '.1em';
		a.style.color = 'aqua';
		div.appendChild(a);
		const b = document.createElement('br');
		div.appendChild(b);
	}

	if (menu.gallery) {
		const a = document.createElement('a');
		a.setAttribute('href', menu.gallery);
		a.innerHTML = '<span class="glyphicon glyphicon glyphicon-th">Gallery</span>';
		a.style.fontWeight = '400';
		a.style.font.family = 'Glyphicons Halflings';
		a.style.padding = '.1em';
		a.style.color = 'aqua';
		div.appendChild(a);
	}

	if (menu.prev) {
		const a = document.createElement('a');
		a.setAttribute('href', menup.rev);
		a.innerHTML = '<span class="glyphicon glyphicon-triangle-left">Prev</span>';
		a.style.content = 'î';
		a.style.font.weight = '400';
		a.style.font.family = 'Glyphicons Halflings';
		a.style.padding = '.1em';
		a.style.color = 'aqua';
		div.appendChild(a);
	}

	if (menu.next) {
		const a = document.createElement('a');
		a.setAttribute('href', menu.next);
		a.innerHTML = '<span class="glyphicon glyphicon-triangle-right">Next</span>';
		a.style.content = 'î';
		a.style.font.weight = '400';
		a.style.font.family = 'Glyphicons Halflings';
		a.style.padding = '.1em';
		a.style.color = 'aqua';
		div.appendChild(a);
	}

	div.style.float = 'right';
	div.style.position = 'fixed';
	div.style.top = '0';
	div.style.right = '0';
	div.style.zIndex = '1';

	console.log('inserting div,');
	console.log(div);
	document.body.insertBefore(div, document.body.childNodes[0]);
}

// Replace the entire page with the image imgElem.
// secondTime: internal use only.
function replacePage(imgSrc, menu, secondTime) {

	let myImage;
	if (secondTime) {
		myImage = document.getElementsByTagName('img')[0];
		myImage.remove();
		myImage.removeAttribute('class');
		myImage.removeAttribute('id');
		myImage.style.position = 'absolute';
		//myImage.style.marginTop = 'auto';
		//myImage.style.marginBottom = 'auto';
		myImage.style.marginRight = 'auto';
		myImage.style.marginLeft = 'auto';
		//myImage.style.left = 'auto';
		//myImage.style.right = 'auto';
		//myImage.style.top = 'auto';
		myImage.style.bottom = 'auto';
		myImage.style.display = 'block';
	}

	document.body.innerHTML = ''; //'<img src="' + obj.src + '" id="the_image1">';
	while (document.body.childNodes.length) {
		document.body.removeChild(document.body.childNodes[0]);
	}
	document.body.removeAttribute('class');
	for (let cls in document.body) {
		if (!document.body.hasOwnProperty(cls))
			continue;
		document.body.removeAttribute(cls);
	}
	removeSiblings(document.body);

	clearListeners();
	
	// remove stylesheets
	const styles = window.document.styleSheets;
	for (let i = styles.length - 1; i >= 0; i--) {
		styles[i].disabled = true;
		// styles.deleteRule(i);
	}
	const rellinks = document.getElementsByTagName('link');
	for (let i = rellinks.length - 1; i >= 0; i--) {
		const rellink = rellinks[i];
		rellink.remove();
	}
	if (document.getElementsByTagName('html')[0].style.overflow)
		document.getElementsByTagName('html')[0].style.overflow = '';

	// Remove scripts.
	const scripts = document.getElementsByTagName('script');
	for (let i = scripts.length - 1; i >= 0; i--) {
		const scp = scripts[i];
		scp.remove();
	}


	// Clone the Firefox default "View Image" page
	const head = document.createElement('head');
	const metaviewport = document.createElement('meta');
	metaviewport.name='viewport';
	metaviewport.content='width=device-width; height=device-height;';
	head.appendChild(metaviewport);

	const imagedoccss = document.createElement('link');
	imagedoccss.rel='stylesheet';
	imagedoccss.href='resource://gre/res/ImageDocument.css';
	head.appendChild(imagedoccss);
	
	const topimagedoccss = document.createElement('link');
	topimagedoccss.rel='stylesheet';
	topimagedoccss.href='resource://gre/res/TopLevelImageDocument.css';
	head.appendChild(topimagedoccss);
	
	const skinimagedoccss = document.createElement('link');
	skinimagedoccss.setAttribute('rel', 'stylesheet');
	skinimagedoccss.href='chrome://global/skin/media/TopLevelImageDocument.css';
	head.appendChild(skinimagedoccss);


	// Last elem created passed to setScaler for scaling.
	let imgelem;
	if (!myImage) {
		imgelem = document.createElement('img');
		imgelem.src = imgSrc;
		imgelem.className = 'decoded overflowing';
		imgelem.id = 'img';
		imgelem.setAttribute('alt', imgSrc);
	}
	else {
		imgelem = myImage;
	}

	const titleElem = document.createElement('title');
	const title = document.createTextNode(imgSrc);
	titleElem.appendChild(title);
	head.appendChild(titleElem);

	document.body.parentNode.insertBefore(head, document.body);
	document.body.appendChild(imgelem);

	title.nodeValue += ' (image ' + imgelem.scrollWidth + ' × ' + imgelem.scrollHeight + ')';

	// Try and prevent the spam
	if (!secondTime) {
		let onloadfunc = function() {
				setTimeout(function() {
				clearListeners();
				replacePage(imgSrc, menu, true);
			}, 1000);};
		document.body.onload = onloadfunc;
		setScaler(imgelem);
	}

	if (menu) {
		//console.log('Setting menu...');
		generateNavLinks(menu);
		//console.log('Set menu.');
	}

	const icon = document.querySelector("link[rel*='icon']") || document.createElement('link');
	icon.type = 'image/x-icon';
	icon.rel = 'shortcut icon';
	icon.href = imgSrc;
	document.getElementsByTagName('head')[0].appendChild(icon);

	return imgelem;
}

function clearListeners(element) {

	if (element != null) {
		element.onclick = null;
		element.onload = null;
	}
	else {
		window.click = null;
		window.onunload = null;
		window.onload = null;
		window.onbeforeunload = null;
		window.onmessage = null;
		document.click = null;
		document.body.click = null;
		document.body.onunload = null;
		document.body.onload = null;
		document.onload = null;
		document.onunload = null;
		document.onmessage = null;
		document.body.onmessage = null;
	}


}

function removeSiblings(element) {
	if (element.parentNode == null)
		return;

	let par = element.parentNode;
	let el;
	while ((el = element.nextSibling) != null) {
		par.removeChild(element.nextSibling);
	}
	while ((el = element.previousSibling) != null) {
		par.removeChild(el);
	}
}

// Sets up scaling, initial cursors, sizes, etc.
function setScaler(element) {
	element.onclick = null;
	element.addEventListener('click', function(e) {
			clearListeners();
			clearListeners(element);
			e.stopPropagation();
			doScale(e, element);
		}, true);
	element.style.cursor = "-moz-zoom-out";
	//element.style.marginLeft = 'auto';
	//element.style.marginRight = 'auto';
}

// Perform scaling on the given element. Assumed the page contents will be removed and no styles will apply.
// To call this function from an onClick, use a wrapper.
function doScale(e, img) {

	// Centered. 2 * offsets bec. those are the borders around the image.
	const docheight = window.innerHeight - 2 * img.offsetTop;//document.documentElement.clientWidth - 2 * img.offsetLeft;
	const docwidth = window.innerWidth - 2 * img.offsetLeft;//document.documentElement.clientHeight - 2 * img.offsetTop;

	// Unresized dimensions
	const width = img.naturalWidth;
	const height = img.naturalHeight;

	// Do nothing if it's not out of bounds.		
	if (width <= docwidth && height <= docheight)
		return;

	let scaleWidth, scaleHeight;

	// Find out which is bigger-er
	if (height / docheight > width / docwidth) {
		const ratio = height / width;
		// Then the height should be the scaling factor
		scaleHeight = docheight;
		scaleWidth = docheight / ratio;
	}
	else {
		// the width should be the scaling factor.
		const ratio = height / width;
		scaleWidth = docwidth;
		scaleHeight = docwidth * ratio;
	}

	// If one of them is equal, consider it scaled. If it's not, it'll just do... nothing.
	//alert( 'width (' + width + ') != img.width (' + img.width + ') || height (' + height + ') != img.height (' + img.height + ')');
	if (width != img.width || height != img.height) {
		// Enlarge the image
		
		// Record the margins so we know where the click happened
		const marginLeft = img.offsetLeft;
		const marginTop = img.offsetTop;

		img.removeAttribute('width');
		img.removeAttribute('height');
		img.style.cursor = "-moz-zoom-out";


		// Center the display on the clicked area
		let mousex, mousey;
		mousex = e.clientX - marginLeft;	// Subtract margins so we get pixels into the image.
		mousey = e.clientY - marginTop;

		// Find the scroll X/Y based on click position.
		// Get the % up/down of the click and convert to enlarged pixel center
		mousex = mousex / scaleWidth * width;
		mousey = mousey / scaleHeight * height;

		//alert('scaled coords: ' + mousex + ',' + mousey);

		// get the center scroll coordinates
		mousex -= window.innerWidth / 2;
		mousey -= window.innerHeight / 2;

		// do the scroll
		window.scroll(mousex, mousey);
		document.body.scrollLeft = mousex;
		document.body.scrollTop = mousey;
	}
	else {
		//alert('Shrinking...' + scaleWidth);
		img.style.cursor = "-moz-zoom-in";
		img.width = scaleWidth;
		img.height = scaleHeight;
	}
}

function ximghostingpro() {
	let form = document.getElementById('imageviewir');
	if (form != null) {
		// it's faked.
		form = form.childNodes;
		for (let i in form) {
			if (form[i].childNodes.length > 3) {
				form = form[i];
				break;
			}
		}
		form.submit();
		return null;
	}
	return document.getElementsByClassName('pic')[0].src;
}

function continueToImagedotdotdot() {
	let pic = document.getElementsByClassName('pic');

	//console.log("Match: " + window.location.href.indexOf('_t.jpg'));
	if (window.location.href.indexOf('_t.jpg') == window.location.href.length - 6) {
		// This doesn't work.
		const cururl = window.location.href;

		const id_idx = cururl.lastIndexOf('/');
		const imgid = cururl.substr(id_idx + 1, cururl.length - id_idx - 1 - 7);

		let dom = window.location.hostname;
		while (dom.lastIndexOf('.') > dom.indexOf('.')) {
			dom = dom.substr(dom.indexOf('.') + 1);
		}

		//console.log('redirecting thumbnail to whole image: ' + window.location.protocol + '://' + dom + '/' + imgid);
		return window.location.protocol + '://' + dom + '/' + imgid;
	}

	let maskedinputs = function() {
		// some spam
		let inner = document.getElementsByClassName('inner')[0];
		if (inner) {
			let i = inner.childNodes.length;
			while (i > 0) {
				let cn = inner.childNodes[i--];
				if (cn && !cn.id)
					inner.removeChild(cn);
			}
		}

		//let inputs = document.getElementsByTagName('input');
		//let input = null;
		//for (let i = 0; i < inputs.length; i++) {
		//	input = inputs[i];
		//	if (input.style.visibility == 'hidden')
		//		continue;
		//}
		//if (input && input.style && input.style.visibility != 'hidden' && input.type != 'text') {
		//	//alert('Visibility: ' + input.style.visibility);
		//	input.click();
		//	return;
		//}
		let buttons = document.getElementsByClassName('blue_btn');
		if (!buttons.length)
			buttons = document.getElementsByClassName('btn_blue');
		if (!buttons.length) {
			let btnsubmit = document.getElementsByTagName('input');
			buttons = [];
			for (const b of btnsubmit) {
				if (b.type == 'submit') {
					buttons.push(b);
				}
			}
		}

		for (const button of buttons) {
			if (button.tagName != 'INPUT' && button.tagName != 'BUTTON')
				continue;

			console.log('button visibility: ' + document.defaultView.getComputedStyle(button, null).visibility);
			if (document.defaultView.getComputedStyle(button, null).visibility != 'hidden') {
				button.click();
				setTimeout(maskedinputs, 4000);
				return null;
			}
		}

		//setTimeout(nextfunc, 300);
		setTimeout(maskedinputs, 400);
	}; // masked inputs
	setTimeout(maskedinputs, 650);


	// The php page...
	// Dig out the Continue to... button.
	let scripts = document.getElementsByTagName('script');
	for (const scriptelem of scripts) {
		const script = scriptelem.innerHTML;
		if (script.indexOf('Continue to Image..."') < 0)
			continue;
		if (script.indexOf('name="op"') < 0)
			continue;
		// The real one is located randomly, outside a for loop.
		let idx = script.indexOf('<Form method=');
		while (idx > 0) {
			const idx2 = script.indexOf('}', idx + 20);
			
			// If idx2 isn't found, we've got the last one. Return it.
			if (idx2 < 0)
				break;

			const idx3 = script.indexOf('for(', idx);
			// If there is no idx3, then again we're inside the last for loop. This is an error.
			if (idx3 < 0) {
				console.log("Oops, looking for the form, we caught ourself in a random for loop.");
				console.log(script);
			}

			// If the closing curly is after the opening for(, then this is the one unique form.
			if (idx3 < idx2) {
				break;
			}

			// Else, we're inside a for loop. Find the next form!
			idx = script.indexOf('<Form method=', idx+20);
		}

		if (idx < 0) {
			console.log("Oops.. failed to find the form.");
			console.log(script);
		}
		const start = idx;
		const end = script.indexOf('</Form', start + 10);
		end += 7;

		let id = script.lastIndexOf('#', start) + 1;
		const lastid = script.indexOf("'", id);
		const lastid1 = script.indexOf('"', id);
		if (lastid1 < lastid)
			lastid = lastid1;
		id = script.substr(id, lastid - id);

		document.getElementById(id).innerHTML = script.substr(start, end - start);
	}
	
	function checkthem() {
		for (const form of document.forms) {
			if (window.getComputedStyle(form).visibility == 'hidden')
				continue;

			if (form.op && form.id) {
				form.next.type = 'hidden';
				form.submit();
				return null;
			}
			else if (form.imgContinue) {
				//form.imgContinue.type = 'hidden';
				if (form.adblock_detect)
					form.adblock_detect.value = '0';
					setTimeout(function() {
							form.imgContinue.click(4,27);
						}, 500);
				//form.submit();
				return null;
			}
		}
		setTimeout(checkthem, 500);
	}
	window.onload = function() {
		clearListeners();
		return;
		setTimeout(checkthem, 500);
	};

	
	function clearlik() {
		clearListeners();
		setTimeout(clearlik, 1000);
	}
	clearlik();
		
	const menu = {};
	if (!pic.length) {
		pic = document.getElementsByClassName('centred');
		if (!pic.length) {
			pic = document.getElementsByClassName('picview');
		}
		if (pic[0].src.substr(pic[0].src.lastIndexOf('/')) == '/1x1.png') {
			pic = [];
		}
		if (!pic.length) {

			// If we got held up at a forward, take the forward..
			// This happens the first time you load each page, it calculates the real url and this is noscript
			//if (document.body.innerHTML.indexOf('<h2>Cannot Load Page???</h2>') > 0) {
			//	let url = document.body.innerHTML.indexOf('window.location');
			//	url = document.body.innerHTML.substr(url + 15 + 2);
			//	
			//	let idx = url.indexOf('"');
			//	if (idx < 3 && idx >= 0)
			//		url = url.substr(idx + 1);

			//	url = url.substr(url, url.indexOf('"'));

			//	alert('twoe' + url);
			//	return url;
			//}

			return;
			// Search the page for a form tag that should be prepended.
			const idx = document.body.innerHTML.indexOf('<Form method="POST" action=""><input type="hidden" name="op" va');
			if (idx > 0) {
				const idx1 = document.body.innerHTML.indexOf('</Form>', idx + 30) + 7;
				const elem = document.getElementById('imageviewiv');
				elem.innerHTML = document.body.innerHTML.substr(idx, idx1 - idx);

				setTimeout(function() { document.forms[0].submit(); }, 500);
				return;
			}
			// Wait and try again.
			setTimeout(continueToImagedotdotdot, 500);
			return;
		}

		if (pic[0]) {
			menu['menuPrev'] = pic[0].parentNode.childNodes[1].href;
			menu['menuNext'] = pic[0].parentNode.childNodes[5].href;
			return replacePage(pic[0].src, menu);
		}
	}

	// else, we must be on the pic page.
	//alert('Got src: ' + pic[0].src);
	return pic[0].src;
}

function getRealUrl(url, urlLow) {
	{
	const idx = urlLow.indexOf('/url/http');
	if (idx > 0) {
		if (urlLow.indexOf('://', idx) - idx < 12) {
			clearListeners();
			return url.substr(idx + 5);
		}
	}
	}

	{
	const idx = urlLow.indexOf('?http');
	if (idx > 0) {
		if (urlLow.substr(idx-1, 6) == '/?http' && urlLow.indexOf('://', idx) - idx < 9) {
			clearListeners();
			return url.substr(idx + 1);
		}
		if (urlLow.substr(idx-6, 11) == '/click?http' && urlLow.indexOf('://', idx) - idx < 9) {
			clearListeners();
			return url.substr(idx + 1);
		}
		if (urlLow.substr(idx-10, 15) == '/click.php?http' && urlLow.indexOf('://', idx) - idx < 9) {
			clearListeners();
			return url.substr(idx + 1);
		}
	}
	}

	return null;
}

function loadonload(img) {
	img.onload = function() {
			window.location.href = img.src;
		};

	if (img.complete) {
		return img.src;
	}
	return null;
}

function forumsubst() {
	const as = document.getElementsByTagName('a');
	for (const a of as) {
		// Substitutions must have :// at the start. They're host substitutions.
		if (!a.href || a.href.indexOf('://') < 0)
			continue;

		let href = a.href;

		if (href.indexOf('://imgclick.net') > 0) {
			const descendents = a.childNodes;
			for (const img in descendents) {
				const src = img.src;
				if (img.tagName == 'IMG' && src && src.indexOf('.imgclick.net/') > 0) {
					a.href = src.substr(0,src.lastIndexOf('_t.')) + src.substr(src.lastIndexOf('.'));
					break;
				} // if the child is an img and is imgclick..
			} // for each child of the link..
		} // if the link is imgclick..
		else {
			// Remove url forwarders
			const realUrl = getRealUrl(href, href.toLowerCase());
			if (realUrl) {
				a.href = realUrl;
				href = realUrl;
			}
		}

		for (const subst of substitutions) {
			const idx = href.indexOf('://' + subst[0]);
			if (idx > 0) {
				a.href = href.substr(0, idx + 3) + subst[1] + href.substr(idx + 3 + subst[0].length);
				break;
			}
		}
	} // For each link..

	// For each image and each link, if it has a substitution, substitude it.
	const imgs = document.getElementsByTagName('img');
	for (const img of imgs) {
		const src = img.src;

		// Substitutions must have :// at the start. They're host substitutions.
		if (!src || src.indexOf('://') < 0)
			continue;

		for (const subst of substitutions) {
			const idx = src.indexOf(subst[0] + '/');
			if (idx > 0) {
				img.src = src.substr(0, idx) + subst[1] + src.substr(idx + subst[0].length);
				break;
			}
		}
	}
	
} // If the url contains a forum URL..

function removeIframes() {
	let iframes = document.getElementsByTagName('iframe');
	while (iframes.length > 0) {
		for (const frm of iframes)
			frm.remove();
		iframes = document.getElementsByTagName('iframe');
	}
}

} // global context
